<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ°ì›”ë“œ ì„œë²„ íŒ¨ë„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0f0f23 100%); min-height: 100vh; }
    .glow-card { background: rgba(17, 17, 40, 0.8); border: 1px solid rgba(99, 102, 241, 0.2); backdrop-filter: blur(10px); }
    .glow-card:hover { border-color: rgba(99, 102, 241, 0.4); }
    .btn-glow { transition: all 0.2s; }
    .btn-glow:hover { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); transform: translateY(-1px); }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .status-dot.online { background: #22c55e; box-shadow: 0 0 10px #22c55e; animation: pulse-green 2s infinite; }
    .status-dot.offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
    @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .slider-custom { -webkit-appearance: none; appearance: none; height: 6px; border-radius: 3px; background: #374151; outline: none; }
    .slider-custom::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #6366f1; cursor: pointer; box-shadow: 0 0 10px rgba(99,102,241,0.5); }
    .slider-custom::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #6366f1; cursor: pointer; border: none; }
    .slider-default-marker { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 2px; height: 14px; background: rgba(156, 163, 175, 0.8); border-radius: 1px; pointer-events: none; z-index: 0; }
    .log-container { font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; }
    .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .tab-btn.active { background: rgba(99, 102, 241, 0.3); border-color: #6366f1; color: white; }
    input[type="number"]::-webkit-inner-spin-button { opacity: 1; }
    .setting-card.changed { border: 1px solid rgba(245, 158, 11, 0.5); background: rgba(245, 158, 11, 0.08); }
  </style>
</head>
<body class="text-gray-200">
  <!-- Toast container -->
  <div id="toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Preset Save Modal -->
  <div id="preset-save-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl max-w-md w-full border border-gray-700 shadow-2xl">
      <div class="p-6">
        <h3 class="text-xl font-bold text-white mb-4">ğŸ“‹ í”„ë¦¬ì…‹ ì €ì¥</h3>
        <p class="text-sm text-gray-400 mb-4">í˜„ì¬ ì„œë²„ ì„¤ì •ì„ í”„ë¦¬ì…‹ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>
        <div class="mb-4">
          <label class="block text-sm text-gray-300 mb-1">í”„ë¦¬ì…‹ ì´ë¦„</label>
          <input type="text" id="preset-name-input" placeholder="ì˜ˆ: ì´ë²¤íŠ¸_2ë°°ê²½í—˜ì¹˜"
            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
        </div>
        <div class="mb-4">
          <label class="block text-sm text-gray-300 mb-1">ì„¤ëª… (ì„ íƒ)</label>
          <input type="text" id="preset-desc-input" placeholder="ì˜ˆ: ì£¼ë§ ì´ë²¤íŠ¸ìš© ì„¤ì •"
            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
        </div>
        <div class="flex gap-3">
          <button onclick="savePreset()" class="flex-1 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium">
            ì €ì¥
          </button>
          <button onclick="closePresetSaveModal()" class="flex-1 px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shutdown Confirmation Modal -->
  <div id="shutdown-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl max-w-md w-full border border-gray-700 shadow-2xl">
      <div class="p-6">
        <h3 class="text-xl font-bold text-white mb-4" id="shutdown-modal-title">ì„œë²„ ì¢…ë£Œ í™•ì¸</h3>
        <div id="shutdown-modal-body" class="text-gray-300 mb-6 space-y-2"></div>
        <div class="flex gap-3">
          <button onclick="confirmShutdown()" class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-lg font-medium">
            ì˜ˆ, ì¢…ë£Œí•©ë‹ˆë‹¤
          </button>
          <button onclick="closeShutdownModal()" class="flex-1 px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Force Shutdown Banner (shows during countdown) -->
  <div id="force-shutdown-banner" class="hidden fixed top-0 left-0 right-0 bg-red-600/95 text-white text-center py-3 text-sm z-40 backdrop-blur shadow-lg">
    <div class="flex items-center justify-center gap-4">
      <span id="shutdown-countdown-text">â³ ì„œë²„ê°€ 60ì´ˆ í›„ ì¢…ë£Œë©ë‹ˆë‹¤...</span>
      <button onclick="forceShutdownNow()" class="px-4 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 font-medium">
        âš¡ ì§€ê¸ˆ ë°”ë¡œ ì¢…ë£Œ
      </button>
    </div>
  </div>

  <!-- Restart banner -->
  <div id="restart-banner" class="hidden fixed top-0 left-0 right-0 bg-amber-600/90 text-white text-center py-2 text-sm z-40 backdrop-blur">
    âš ï¸ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤.
    <button onclick="serverAction('restart')" class="ml-3 px-3 py-1 bg-white/20 rounded hover:bg-white/30 text-sm">ì§€ê¸ˆ ì¬ì‹œì‘</button>
  </div>

  <!-- Header -->
  <header class="border-b border-gray-700/50 bg-gray-900/50 backdrop-blur sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸ®</span>
        <h1 class="text-xl font-bold text-white">íŒ°ì›”ë“œ ì„œë²„ íŒ¨ë„</h1>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2" id="status-display">
          <span id="server-status-dot" class="status-dot <%= running ? 'online' : 'offline' %>"></span>
          <span id="server-status-label" class="text-sm"><%= running ? 'ì‹¤í–‰ ì¤‘' : 'ì •ì§€' %></span>
        </div>
        <a href="/logout" class="text-gray-400 hover:text-white text-sm">ë¡œê·¸ì•„ì›ƒ</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Server controls -->
    <div class="glow-card rounded-2xl p-6 mb-6">
      <h2 class="text-lg font-semibold text-white mb-4">ğŸ–¥ï¸ ì„œë²„ ê´€ë¦¬</h2>
      <div class="flex flex-wrap gap-3 mb-4">
        <button onclick="serverAction('start')" class="btn-glow px-5 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl font-medium text-sm">
          â–¶ï¸ ì‹œì‘
        </button>
        <button onclick="serverAction('stop')" class="btn-glow px-5 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-xl font-medium text-sm">
          â¹ï¸ ì •ì§€
        </button>
        <button onclick="serverAction('restart')" class="btn-glow px-5 py-2.5 bg-amber-600 hover:bg-amber-500 text-white rounded-xl font-medium text-sm">
          ğŸ”„ ì¬ì‹œì‘
        </button>
        <button onclick="runBackup()" class="btn-glow px-5 py-2.5 bg-violet-600 hover:bg-violet-500 text-white rounded-xl font-medium text-sm">
          ğŸ’¾ ë°±ì—…í•˜ê¸°
        </button>
      </div>
      <!-- Logs -->
      <details class="group">
        <summary class="cursor-pointer text-gray-400 hover:text-gray-300 text-sm select-none">ğŸ“‹ ì„œë²„ ë¡œê·¸ (ìµœê·¼ 50ì¤„)</summary>
        <div class="mt-3 bg-black/50 rounded-xl p-4 max-h-64 overflow-y-auto log-container" id="log-container">
          <div id="logs" class="text-green-400 whitespace-pre-wrap">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </details>

      <!-- ì ‘ì† í˜„í™© -->
      <div class="mt-6 pt-4 border-t border-gray-700/50">
        <h3 class="text-sm font-semibold text-white mb-2">ğŸ‘¥ ì ‘ì† í˜„í™©</h3>
        <p class="text-xs text-gray-500 mb-2">ì´ˆë¡: í˜„ì¬ ì ‘ì† ì¤‘ Â· íšŒìƒ‰: í•œ ë²ˆì´ë¼ë„ ì ‘ì†í•œ ì„œë²„ ì¸ì› (ì¬ì‹œì‘/ì •ì§€ ì‹œ ì•Œë¦¼ ëŒ€ìƒ)</p>
        <div id="players-list" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- REST API Status -->
      <div class="mb-3 p-3 rounded-lg bg-gray-800/50 border border-gray-700">
        <h4 class="text-xs font-semibold text-gray-400 mb-2">ğŸ” REST API ìƒíƒœ</h4>
        <div class="text-xs">
          <div id="rest-api-status" class="flex items-center gap-2">
            <span class="status-dot offline"></span>
            <span class="text-gray-400">í™•ì¸ ì¤‘...</span>
          </div>
        </div>
        <details class="mt-2 text-xs text-gray-500">
          <summary class="cursor-pointer hover:text-gray-400">ë„ì›€ë§</summary>
          <p class="mt-1">REST APIê°€ í™œì„±í™”ë˜ì–´ì•¼ í”Œë ˆì´ì–´ ì ‘ì† ê°ì§€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <p>ì„¤ì •ì—ì„œ RESTAPIEnabled=True, AdminPassword ì„¤ì • í›„ ì„œë²„ ì¬ì‹œì‘í•˜ì„¸ìš”.</p>
        </details>
      </div>

      <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
      <div class="mt-6 pt-4 border-t border-gray-700/50">
        <h3 class="text-sm font-semibold text-white mb-3">ğŸ“Š ì ‘ì† í†µê³„</h3>

        <!-- í†µê³„ íƒ­ -->
        <div class="flex gap-1 mb-3 items-center">
          <button onclick="switchStatsTab('players')" data-stats-tab="players" class="stats-tab-btn px-3 py-1.5 text-xs rounded-lg bg-indigo-600 text-white">í”Œë ˆì´ì–´ í†µê³„</button>
          <button onclick="switchStatsTab('daily')" data-stats-tab="daily" class="stats-tab-btn px-3 py-1.5 text-xs rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600">ì¼ë³„ í†µê³„</button>
          <button onclick="switchStatsTab('sessions')" data-stats-tab="sessions" class="stats-tab-btn px-3 py-1.5 text-xs rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600">ìµœê·¼ ì„¸ì…˜</button>
          <button onclick="refreshStats()" id="stats-refresh-btn" class="ml-auto px-3 py-1.5 text-xs rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600">ğŸ”„ ê°±ì‹ </button>
        </div>

        <!-- í”Œë ˆì´ì–´ í†µê³„ -->
        <div id="stats-players" class="stats-content bg-black/30 rounded-xl overflow-hidden">
          <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr>
                <th class="px-4 py-2 font-medium">í”Œë ˆì´ì–´</th>
                <th class="px-4 py-2 font-medium">ì´ í”Œë ˆì´ ì‹œê°„</th>
                <th class="px-4 py-2 font-medium">ì ‘ì† íšŸìˆ˜</th>
                <th class="px-4 py-2 font-medium">ìµœê·¼ ì ‘ì†</th>
              </tr>
            </thead>
            <tbody id="stats-players-tbody" class="text-gray-300"></tbody>
          </table>
          <div id="stats-players-empty" class="hidden text-center py-8 text-gray-500 text-sm">ì•„ì§ ì ‘ì† ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>

        <!-- ì¼ë³„ í†µê³„ -->
        <div id="stats-daily" class="stats-content hidden bg-black/30 rounded-xl overflow-hidden">
          <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr>
                <th class="px-4 py-2 font-medium">ë‚ ì§œ</th>
                <th class="px-4 py-2 font-medium">ê³ ìœ  ì ‘ì†ì</th>
                <th class="px-4 py-2 font-medium">ì„¸ì…˜ ìˆ˜</th>
                <th class="px-4 py-2 font-medium">ì´ í”Œë ˆì´ ì‹œê°„</th>
              </tr>
            </thead>
            <tbody id="stats-daily-tbody" class="text-gray-300"></tbody>
          </table>
          <div id="stats-daily-empty" class="hidden text-center py-8 text-gray-500 text-sm">ì•„ì§ ì¼ë³„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>

        <!-- ìµœê·¼ ì„¸ì…˜ -->
        <div id="stats-sessions" class="stats-content hidden bg-black/30 rounded-xl overflow-hidden">
          <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr>
                <th class="px-4 py-2 font-medium">í”Œë ˆì´ì–´</th>
                <th class="px-4 py-2 font-medium">ì ‘ì† ì‹œê°„</th>
                <th class="px-4 py-2 font-medium">í‡´ì¥ ì‹œê°„</th>
                <th class="px-4 py-2 font-medium">í”Œë ˆì´ ì‹œê°„</th>
              </tr>
            </thead>
            <tbody id="stats-sessions-tbody" class="text-gray-300"></tbody>
          </table>
          <div id="stats-sessions-empty" class="hidden text-center py-8 text-gray-500 text-sm">ì•„ì§ ì„¸ì…˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div class="glow-card rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-white">âš™ï¸ ì„œë²„ ì„¤ì •</h2>
        <div class="flex items-center gap-2">
          <!-- í”„ë¦¬ì…‹ ë“œë¡­ë‹¤ìš´ -->
          <div class="relative" id="preset-wrapper">
            <button onclick="togglePresetMenu()" class="btn-glow px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-medium text-sm flex items-center gap-1">
              ğŸ“‹ í”„ë¦¬ì…‹ <span class="text-xs">â–¼</span>
            </button>
            <div id="preset-menu" class="hidden absolute right-0 top-12 w-72 bg-gray-800 border border-gray-600 rounded-xl shadow-2xl z-50 overflow-hidden">
              <button onclick="openPresetSaveModal()" class="w-full px-4 py-3 text-left text-sm text-indigo-300 hover:bg-gray-700 flex items-center gap-2">
                ğŸ’¾ í˜„ì¬ ì„¤ì •ì„ í”„ë¦¬ì…‹ìœ¼ë¡œ ì €ì¥
              </button>
              <div class="border-t border-gray-700"></div>
              <div id="preset-list" class="max-h-64 overflow-y-auto">
                <div class="px-4 py-3 text-xs text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              </div>
            </div>
          </div>
          <button onclick="saveSettings()" id="save-btn"
            class="btn-glow px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-medium text-sm">
            ğŸ’¾ ì„¤ì • ì €ì¥
          </button>
        </div>
      </div>
      <p class="text-xs text-gray-500 mb-4">ğŸ“ <%= settingsPath %></p>

      <div id="unsaved-banner" class="hidden mb-4 p-4 rounded-xl bg-amber-500/20 border border-amber-500/50 text-amber-200 text-sm">
        <div class="font-medium mb-1">âš ï¸ ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤</div>
        <p class="text-amber-200/90 text-xs mb-2">ì•„ë˜ ì„¤ì •ë“¤ì€ ì €ì¥í•´ì•¼ ì„œë²„ì— ì ìš©ë©ë‹ˆë‹¤.</p>
        <div id="unsaved-list" class="flex flex-wrap gap-2 text-xs"></div>
      </div>

      <% if (!settings) { %>
        <div class="bg-red-500/20 border border-red-500/50 text-red-300 px-4 py-3 rounded-lg">
          âš ï¸ ì„¤ì • íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.
        </div>
      <% } else { %>
        <!-- Category tabs -->
        <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-700/50 pb-4">
          <% categories.forEach((cat, i) => { %>
            <button onclick="switchTab('<%= cat %>')"
              class="tab-btn px-4 py-2 rounded-lg text-sm border border-gray-600 text-gray-400 hover:text-white hover:border-gray-400 transition <%= i === 0 ? 'active' : '' %>"
              data-tab="<%= cat %>">
              <%= cat %>
            </button>
          <% }) %>
        </div>

        <!-- Settings form -->
        <form id="settings-form">
          <% categories.forEach((cat, i) => { %>
            <div class="tab-content <%= i === 0 ? '' : 'hidden' %>" data-tab="<%= cat %>">
              <div class="grid gap-4 md:grid-cols-2">
                <% (cat === 'ì „ì²´' ? defs : defs.filter(d => d.category === cat)).forEach(def => { %>
                  <% const val = settings[def.key] !== undefined ? settings[def.key] : def.default; %>
                  <div class="setting-card bg-gray-800/50 rounded-xl p-4 transition-all" data-setting-key="<%= def.key %>" data-label="<%= def.label %>">
                    <div class="flex items-start justify-between mb-1">
                      <label class="text-sm font-medium text-gray-200"><%= def.label %></label>
                      <% if (def.type === 'slider') { %>
                        <input type="number" name="<%= def.key %>" id="val-<%= def.key %>" value="<%= val %>"
                          min="<%= def.min %>" max="<%= def.max %>" step="<%= def.step %>"
                          class="slider-edit w-20 bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-sm text-indigo-400 font-mono text-right focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                          data-slider-id="slider-<%= def.key %>" data-min="<%= def.min %>" data-max="<%= def.max %>"
                          oninput="syncSliderFromEdit(this)">
                      <% } %>
                    </div>
                    <p class="text-xs text-gray-500 mb-2"><%= def.desc %></p>

                    <% if (def.type === 'slider') { %>
                      <div class="relative">
                        <input type="range" id="slider-<%= def.key %>" value="<%= val %>"
                          min="<%= def.min %>" max="<%= def.max %>" step="<%= def.step %>"
                          class="w-full slider-custom"
                          data-edit-id="val-<%= def.key %>"
                          oninput="syncEditFromSlider(this)">
                        <span class="slider-default-marker" style="left: <%= ((Number(def.default) - def.min) / (def.max - def.min) * 100) %>%" title="ê¸°ë³¸ê°’: <%= def.default %>"></span>
                      </div>
                      <p class="text-xs text-gray-500 mt-1">ê¸°ë³¸ê°’: <span class="text-gray-400 font-mono"><%= def.default %></span></p>

                    <% } else if (def.type === 'boolean') { %>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="<%= def.key %>" class="sr-only peer"
                          <%= (String(val) === 'True' || val === true) ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-600 peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                      </label>

                    <% } else if (def.type === 'select') { %>
                      <select name="<%= def.key %>"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <% def.options.forEach(opt => { %>
                          <option value="<%= opt %>" <%= String(val) === opt ? 'selected' : '' %>><%= opt %></option>
                        <% }) %>
                      </select>

                    <% } else if (def.type === 'number') { %>
                      <input type="number" name="<%= def.key %>" value="<%= val %>"
                        <% if (def.min !== undefined) { %>min="<%= def.min %>"<% } %>
                        <% if (def.max !== undefined) { %>max="<%= def.max %>"<% } %>
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">

                    <% } else { %>
                      <input type="text" name="<%= def.key %>" value="<%= val %>"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <% } %>
                  </div>
                <% }) %>
              </div>
            </div>
          <% }) %>
        </form>
      <% } %>
    </div>
  </main>

  <footer class="text-center py-6 text-gray-600 text-xs">
    Palworld Server Panel v1.0
  </footer>

  <script>
    function syncEditFromSlider(sliderEl) {
      const edit = document.getElementById(sliderEl.dataset.editId);
      if (edit) edit.value = sliderEl.value;
    }
    function syncSliderFromEdit(editEl) {
      const slider = document.getElementById(editEl.dataset.sliderId);
      if (!slider) return;
      const min = Number(slider.min);
      const max = Number(slider.max);
      const step = Number(slider.step) || 0.1;
      let v = Number(editEl.value);
      if (isNaN(v)) v = min;
      v = Math.max(min, Math.min(max, v));
      v = Math.round(v / step) * step;
      editEl.value = v;
      slider.value = v;
    }

    // Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('hidden', c.dataset.tab !== tab));
    }

    // Toast
    function showToast(msg, type = 'success') {
      const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-amber-600' };
      const div = document.createElement('div');
      div.className = `toast ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg text-sm`;
      div.textContent = msg;
      document.getElementById('toasts').appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // Global variables for shutdown
    let shutdownAction = null; // 'stop' or 'restart'

    // Server actions
    async function serverAction(action) {
      // For stop/restart, show confirmation modal with player list
      if (action === 'stop' || action === 'restart') {
        try {
          const res = await fetch('/api/players');
          const data = await res.json();
          const onlinePlayers = data.online || [];
          const playerNames = data.playerNames || {};

          if (onlinePlayers.length === 0) {
            // No players, confirm and proceed directly
            if (!confirm(`í˜„ì¬ ì ‘ì† ì¤‘ì¸ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.\n${action === 'stop' ? 'ì„œë²„ë¥¼ ì •ì§€' : 'ì„œë²„ë¥¼ ì¬ì‹œì‘'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            await executeServerAction(action);
          } else {
            // Players online, show custom modal
            shutdownAction = action;
            showShutdownModal(onlinePlayers, playerNames, action);
          }
        } catch (e) {
          showToast('ì ‘ì†ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message, 'error');
        }
      } else {
        // For 'start', execute directly
        await executeServerAction(action);
      }
    }

    async function executeServerAction(action) {
      try {
        const res = await fetch(`/api/server/${action}`, { method: 'POST' });
        const data = await res.json();
        showToast(data.message, data.success ? 'success' : 'error');
        if (action === 'restart') document.getElementById('restart-banner').classList.add('hidden');
        setTimeout(refreshStatus, 2000);
      } catch (e) {
        showToast('ìš”ì²­ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    function showShutdownModal(onlinePlayers, playerNames, action) {
      const modal = document.getElementById('shutdown-modal');
      const title = document.getElementById('shutdown-modal-title');
      const body = document.getElementById('shutdown-modal-body');

      title.textContent = action === 'stop' ? 'ì„œë²„ ì¢…ë£Œ í™•ì¸' : 'ì„œë²„ ì¬ì‹œì‘ í™•ì¸';

      // Build player list
      const playerListHtml = onlinePlayers.map(userId => {
        const displayName = playerNames[userId] || userId;
        return `<span class="inline-block px-2 py-1 bg-green-600/20 border border-green-600/50 rounded text-green-300 text-sm">${escapeHtml(displayName)}</span>`;
      }).join(' ');

      body.innerHTML = `
        <p class="font-semibold">í˜„ì¬ <span class="text-green-400">${onlinePlayers.length}ëª…</span>ì˜ ì‚¬ìš©ìê°€ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤:</p>
        <div class="flex flex-wrap gap-2 my-3">${playerListHtml}</div>
        <p class="text-sm text-gray-400">ì •ë§ë¡œ ${action === 'stop' ? 'ì„œë²„ë¥¼ ì¢…ë£Œ' : 'ì„œë²„ë¥¼ ì¬ì‹œì‘'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p class="text-xs text-amber-400 mt-2">âš ï¸ 60ì´ˆ í›„ì— ì„œë²„ê°€ ì¢…ë£Œë˜ë©°, í”Œë ˆì´ì–´ë“¤ì—ê²Œ ê³µì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.</p>
      `;

      modal.classList.remove('hidden');
    }

    function closeShutdownModal() {
      document.getElementById('shutdown-modal').classList.add('hidden');
      shutdownAction = null;
    }

    async function confirmShutdown() {
      closeShutdownModal();
      if (!shutdownAction) return;

      try {
        // Call stop-with-notice API
        const res = await fetch('/api/server/stop-with-notice', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showToast(data.message, 'success');
          // Show force shutdown banner
          document.getElementById('force-shutdown-banner').classList.remove('hidden');

          // If restart, schedule restart after shutdown
          if (shutdownAction === 'restart') {
            setTimeout(async () => {
              await executeServerAction('start');
              document.getElementById('force-shutdown-banner').classList.add('hidden');
            }, 70000); // 60s + 10s = 70s total
          } else {
            // Hide banner after shutdown completes
            setTimeout(() => {
              document.getElementById('force-shutdown-banner').classList.add('hidden');
            }, 70000);
          }

          setTimeout(refreshStatus, 2000);
        } else {
          showToast(data.message, 'error');
        }
      } catch (e) {
        showToast('ì¢…ë£Œ ìš”ì²­ ì‹¤íŒ¨: ' + e.message, 'error');
      }

      shutdownAction = null;
    }

    async function forceShutdownNow() {
      if (!confirm('ì •ë§ë¡œ ì§€ê¸ˆ ë°”ë¡œ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní”Œë ˆì´ì–´ë“¤ì´ ì €ì¥í•  ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.')) return;

      try {
        const res = await fetch('/api/server/force-stop', { method: 'POST' });
        const data = await res.json();
        showToast(data.message, data.success ? 'success' : 'error');
        document.getElementById('force-shutdown-banner').classList.add('hidden');
        setTimeout(refreshStatus, 2000);
      } catch (e) {
        showToast('ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    async function runBackup() {
      try {
        const res = await fetch('/api/backup/now', { method: 'POST' });
        const data = await res.json();
        showToast(data.message, data.success ? 'success' : 'error');
      } catch (e) {
        showToast('ë°±ì—… ìš”ì²­ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    function getFormData(form) {
      const data = {};
      form.querySelectorAll('input, select').forEach(el => {
        if (el.type === 'checkbox') data[el.name] = el.checked;
        else data[el.name] = el.value;
      });
      return data;
    }

    function getChangedKeys() {
      const form = document.getElementById('settings-form');
      if (!form) return [];
      const current = getFormData(form);
      const keys = [];
      for (const k of Object.keys(initialSettings)) {
        const a = initialSettings[k];
        const b = current[k];
        if (typeof a === 'boolean' || typeof b === 'boolean') {
          if (a !== b) keys.push(k);
        } else if (String(a) !== String(b)) {
          keys.push(k);
        }
      }
      return keys;
    }

    function updateUnsavedUI() {
      const form = document.getElementById('settings-form');
      if (!form) return;
      const keys = getChangedKeys();
      const banner = document.getElementById('unsaved-banner');
      const listEl = document.getElementById('unsaved-list');
      document.querySelectorAll('.setting-card').forEach(card => {
        card.classList.toggle('changed', keys.includes(card.dataset.settingKey));
      });
      if (keys.length === 0) {
        banner.classList.add('hidden');
        return;
      }
      banner.classList.remove('hidden');
      const labels = keys.map(k => {
        const card = form.querySelector('[data-setting-key="' + k + '"]');
        return card ? card.dataset.label || k : k;
      });
      listEl.textContent = '';
      labels.forEach(l => {
        const span = document.createElement('span');
        span.className = 'px-2 py-1 rounded bg-amber-500/30 text-amber-200';
        span.textContent = l;
        listEl.appendChild(span);
      });
    }

    let initialSettings = {};
    (function initUnsavedTracking() {
      const form = document.getElementById('settings-form');
      if (!form) return;
      initialSettings = getFormData(form);
      form.addEventListener('input', updateUnsavedUI);
      form.addEventListener('change', updateUnsavedUI);
    })();

    async function saveSettings() {
      const form = document.getElementById('settings-form');
      const data = getFormData(form);
      try {
        const res = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          initialSettings = getFormData(form);
          updateUnsavedUI();
          showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          if (result.needRestart) {
            document.getElementById('restart-banner').classList.remove('hidden');
          }
        } else {
          showToast(result.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
        }
      } catch (e) {
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    // Refresh status & logs
    async function refreshStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        const dot = document.getElementById('server-status-dot');
        const label = document.getElementById('server-status-label');
        dot.className = `status-dot ${data.running ? 'online' : 'offline'}`;
        label.textContent = data.running ? 'ì‹¤í–‰ ì¤‘' : 'ì •ì§€';
        document.getElementById('logs').textContent = data.logs.length ? data.logs.join('\n') : 'ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
        const lc = document.getElementById('log-container');
        lc.scrollTop = lc.scrollHeight;
        if (data.players) {
          const onlineSet = new Set((data.players.online || []));
          const members = data.players.members || [];
          const playerNames = data.players.playerNames || {};
          const listEl = document.getElementById('players-list');
          listEl.innerHTML = members.length === 0
            ? '<span class="text-gray-500 text-sm">ì ‘ì† ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>'
            : members.map(id => {
                const isOn = onlineSet.has(id);
                const displayName = playerNames[id] || id;
                return '<span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm ' + (isOn ? 'bg-green-500/20 text-green-300' : 'bg-gray-600/50 text-gray-400') + '">' +
                  '<span class="w-2 h-2 rounded-full ' + (isOn ? 'bg-green-500' : 'bg-gray-500') + '"></span>' + escapeHtml(displayName) + '</span>';
              }).join('');

          // Update REST API status
          if (data.players.detectionMethod) {
            const method = data.players.detectionMethod;
            const restStatus = document.getElementById('rest-api-status');
            const restDot = restStatus.querySelector('.status-dot');
            const restLabel = restStatus.querySelector('span:nth-child(2)');

            if (method.enabled && method.available) {
              restDot.className = 'status-dot online';
              restLabel.textContent = 'REST API: í™œì„± âœ“';
              restLabel.className = 'text-green-400';
            } else if (method.enabled && !method.available) {
              restDot.className = 'status-dot offline';
              restLabel.textContent = 'REST API: ì˜¤ë¥˜ - ' + (method.error || 'ì—°ê²° ì‹¤íŒ¨');
              restLabel.className = 'text-red-400';
            } else {
              restDot.className = 'status-dot offline';
              restLabel.textContent = 'REST API: ë¹„í™œì„±';
              restLabel.className = 'text-gray-500';
            }
          }
        }
      } catch {}
    }
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    // --- í†µê³„ ëŒ€ì‹œë³´ë“œ ---
    function switchStatsTab(tab) {
      document.querySelectorAll('.stats-tab-btn').forEach(b => {
        if (b.dataset.statsTab === tab) {
          b.className = 'stats-tab-btn px-3 py-1.5 text-xs rounded-lg bg-indigo-600 text-white';
        } else {
          b.className = 'stats-tab-btn px-3 py-1.5 text-xs rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600';
        }
      });
      document.querySelectorAll('.stats-content').forEach(c => c.classList.add('hidden'));
      document.getElementById('stats-' + tab).classList.remove('hidden');
      loadStats(tab);
    }

    function formatDuration(mins) {
      if (!mins || mins <= 0) return '-';
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      return h > 0 ? (h + 'ì‹œê°„ ' + m + 'ë¶„') : (m + 'ë¶„');
    }

    function formatTime(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }) + ' ' +
             d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    async function loadStats(tab) {
      try {
        if (tab === 'players') {
          const res = await fetch('/api/stats/players');
          const data = await res.json();
          const tbody = document.getElementById('stats-players-tbody');
          const empty = document.getElementById('stats-players-empty');
          if (!data.players || data.players.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
          }
          empty.classList.add('hidden');
          tbody.innerHTML = data.players.map(p => {
            const name = escapeHtml(p.displayName || p.userId);
            const time = formatDuration(p.totalPlaytimeMinutes);
            const online = p.isOnline ? '<span class="ml-1 text-green-400 text-xs">â— ì ‘ì† ì¤‘</span>' : '';
            const lastSeen = p.isOnline ? '<span class="text-green-400">ì ‘ì† ì¤‘</span>' : formatTime(p.lastSeen);
            return '<tr class="border-b border-gray-700/50">' +
              '<td class="px-4 py-2">' + name + online + '</td>' +
              '<td class="px-4 py-2 font-mono">' + time + '</td>' +
              '<td class="px-4 py-2 text-center">' + p.totalSessions + 'íšŒ</td>' +
              '<td class="px-4 py-2 text-gray-400">' + lastSeen + '</td></tr>';
          }).join('');
        } else if (tab === 'daily') {
          const res = await fetch('/api/stats/daily?days=30');
          const data = await res.json();
          const tbody = document.getElementById('stats-daily-tbody');
          const empty = document.getElementById('stats-daily-empty');
          if (!data.daily || data.daily.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
          }
          empty.classList.add('hidden');
          tbody.innerHTML = data.daily.map(d => {
            return '<tr class="border-b border-gray-700/50">' +
              '<td class="px-4 py-2">' + escapeHtml(d.day) + '</td>' +
              '<td class="px-4 py-2 text-center">' + d.uniquePlayers + 'ëª…</td>' +
              '<td class="px-4 py-2 text-center">' + d.totalSessions + 'íšŒ</td>' +
              '<td class="px-4 py-2 font-mono">' + formatDuration(d.totalMinutes) + '</td></tr>';
          }).join('');
        } else if (tab === 'sessions') {
          const res = await fetch('/api/stats/sessions?limit=50');
          const data = await res.json();
          const tbody = document.getElementById('stats-sessions-tbody');
          const empty = document.getElementById('stats-sessions-empty');
          if (!data.sessions || data.sessions.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
          }
          empty.classList.add('hidden');
          tbody.innerHTML = data.sessions.map(s => {
            const name = escapeHtml(s.displayName || s.playerName || s.userId);
            const joinStr = formatTime(s.joinTime);
            const leaveStr = s.leaveTime ? formatTime(s.leaveTime) : '<span class="text-green-400">ì ‘ì† ì¤‘</span>';
            const dur = s.durationMinutes ? formatDuration(s.durationMinutes) : '<span class="text-green-400">ì§„í–‰ ì¤‘</span>';
            return '<tr class="border-b border-gray-700/50">' +
              '<td class="px-4 py-2">' + name + '</td>' +
              '<td class="px-4 py-2 text-gray-400">' + joinStr + '</td>' +
              '<td class="px-4 py-2 text-gray-400">' + leaveStr + '</td>' +
              '<td class="px-4 py-2 font-mono">' + dur + '</td></tr>';
          }).join('');
        }
      } catch (e) {
        console.error('Stats load error:', e);
      }
    }

    // ì´ˆê¸° ë¡œë“œ
    let currentStatsTab = 'players';
    const _origSwitchTab = switchStatsTab;
    switchStatsTab = function(tab) { currentStatsTab = tab; _origSwitchTab(tab); };

    loadStats('players');
    refreshStatus();

    // ì ‘ì† í˜„í™© + í†µê³„ ë™ì¼ ì£¼ê¸°ë¡œ ê°±ì‹  (5ì´ˆ)
    setInterval(() => {
      refreshStatus();
      loadStats(currentStatsTab);
    }, 5000);

    async function refreshStats() {
      const btn = document.getElementById('stats-refresh-btn');
      btn.textContent = 'â³ ê°±ì‹  ì¤‘...';
      btn.disabled = true;
      await loadStats(currentStatsTab);
      btn.textContent = 'ğŸ”„ ê°±ì‹ ';
      btn.disabled = false;
    }

    // --- í”„ë¦¬ì…‹ ---
    function togglePresetMenu() {
      const menu = document.getElementById('preset-menu');
      const isHidden = menu.classList.contains('hidden');
      menu.classList.toggle('hidden');
      if (isHidden) loadPresetList();
    }
    document.addEventListener('click', (e) => {
      const wrapper = document.getElementById('preset-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        document.getElementById('preset-menu').classList.add('hidden');
      }
    });

    async function loadPresetList() {
      const listEl = document.getElementById('preset-list');
      try {
        const res = await fetch('/api/presets');
        const presets = await res.json();
        if (presets.length === 0) {
          listEl.innerHTML = '<div class="px-4 py-3 text-xs text-gray-500">ì €ì¥ëœ í”„ë¦¬ì…‹ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        listEl.innerHTML = presets.map(p => {
          const date = new Date(p.createdAt).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          return '<div class="flex items-center justify-between px-4 py-2.5 hover:bg-gray-700 group">' +
            '<button onclick="loadPreset(\'' + escapeHtml(p.name) + '\')" class="flex-1 text-left">' +
              '<div class="text-sm text-white">' + escapeHtml(p.name) + '</div>' +
              '<div class="text-xs text-gray-500">' + (p.description ? escapeHtml(p.description) + ' Â· ' : '') + date + '</div>' +
            '</button>' +
            '<button onclick="event.stopPropagation();deletePreset(\'' + escapeHtml(p.name) + '\')" class="ml-2 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 text-xs px-1">âœ•</button>' +
          '</div>';
        }).join('');
      } catch (e) {
        listEl.innerHTML = '<div class="px-4 py-3 text-xs text-red-400">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
      }
    }

    function openPresetSaveModal() {
      document.getElementById('preset-menu').classList.add('hidden');
      document.getElementById('preset-save-modal').classList.remove('hidden');
      document.getElementById('preset-name-input').value = '';
      document.getElementById('preset-desc-input').value = '';
      document.getElementById('preset-name-input').focus();
    }
    function closePresetSaveModal() {
      document.getElementById('preset-save-modal').classList.add('hidden');
    }

    async function savePreset() {
      const name = document.getElementById('preset-name-input').value.trim();
      const description = document.getElementById('preset-desc-input').value.trim();
      if (!name) { showToast('í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error'); return; }
      try {
        const res = await fetch('/api/presets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        const data = await res.json();
        if (data.success) {
          showToast('í”„ë¦¬ì…‹ "' + data.name + '" ì €ì¥ ì™„ë£Œ!');
          closePresetSaveModal();
        } else {
          showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
        }
      } catch (e) {
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    async function loadPreset(name) {
      if (!confirm('í”„ë¦¬ì…‹ "' + name + '"ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì„¤ì •ì´ í”„ë¦¬ì…‹ ê°’ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;
      document.getElementById('preset-menu').classList.add('hidden');
      try {
        const res = await fetch('/api/presets/' + encodeURIComponent(name) + '/load', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showToast('í”„ë¦¬ì…‹ "' + name + '" ì ìš© ì™„ë£Œ!');
          if (data.needRestart) document.getElementById('restart-banner').classList.remove('hidden');
          setTimeout(() => location.reload(), 500);
        } else {
          showToast(data.error || 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
        }
      } catch (e) {
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }

    async function deletePreset(name) {
      if (!confirm('í”„ë¦¬ì…‹ "' + name + '"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const res = await fetch('/api/presets/' + encodeURIComponent(name), { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          showToast('í”„ë¦¬ì…‹ ì‚­ì œë¨');
          loadPresetList();
        } else {
          showToast(data.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
        }
      } catch (e) {
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }
  </script>
</body>
</html>
